---
const authList = [
  {
    saltB64: "hlcpS8dUqTz2VhZun/9qJA==",
    expectedB64: "11910HDiNACBvwOOEN0IdUD7Aq0CW4dd4rtMLflksGg=",
    iters: 210000,
  },
  // Add more password entries here:
  {
    saltB64: "Awc80DFPJuatLBJHLy38cQ==",
    expectedB64: "Hct0ws4h5wBTsIIv9+fFaqXuB/xc8cVyH+9qMCERcvU=",
    iters: 210000,
  },
];
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="robots" content="noindex, nofollow" />
    <meta name="googlebot" content="noindex, nofollow" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Protected</title>
    <style>
      body {
        font-family: system-ui;
        display: grid;
        place-items: center;
        min-height: 100vh;
        margin: 0;
        padding: 24px;
      }
      .card {
        max-width: 420px;
        width: 100%;
        border: 1px solid #ddd;
        border-radius: 12px;
        padding: 20px;
      }
      input,
      button {
        width: 100%;
        padding: 12px;
        border-radius: 10px;
        border: 1px solid #ccc;
        font-size: 16px;
      }
      button {
        margin-top: 12px;
        cursor: pointer;
      }
      .err {
        color: #b00020;
        margin-top: 10px;
        min-height: 1.2em;
      }
    </style>
  </head>

  <body>
    <div class="card">
      <h1 style="margin:0 0 12px">Enter password</h1>
      <input id="pw" type="password" autocomplete="current-password" />
      <button id="go">Continue</button>
      <div class="err" id="err"></div>
    </div>

    <script define:vars={{ authList }}>
      const KEY = "auth_ok_v1";
      const AUTH_LIST = authList;

      const nextPath =
        new URLSearchParams(location.search).get("next") || "/home";

      function b64ToBytes(b64) {
        const bin = atob(b64);
        const out = new Uint8Array(bin.length);
        for (let i = 0; i < bin.length; i++) out[i] = bin.charCodeAt(i);
        return out;
      }

      function bytesToB64(bytes) {
        let bin = "";
        for (const b of bytes) bin += String.fromCharCode(b);
        return btoa(bin);
      }

      async function derive(pw, saltB64, iters) {
        const enc = new TextEncoder();
        const keyMaterial = await crypto.subtle.importKey(
          "raw",
          enc.encode(pw),
          "PBKDF2",
          false,
          ["deriveBits"],
        );

        const salt = b64ToBytes(saltB64);

        const bits = await crypto.subtle.deriveBits(
          { name: "PBKDF2", hash: "SHA-256", salt, iterations: iters },
          keyMaterial,
          256,
        );

        return bytesToB64(new Uint8Array(bits));
      }

      (function init() {
        if (sessionStorage.getItem(KEY) === "1") {
          location.replace(nextPath);
          return;
        }

        const pw = document.getElementById("pw");
        const err = document.getElementById("err");
        const go = document.getElementById("go");

        let fails = 0;

        async function submit() {
          err.textContent = "";
          const val = pw.value || "";
          if (!val) return;

          if (fails > 0) {
            await new Promise((r) => setTimeout(r, Math.min(900, fails * 200)));
          }

          const derivedList = await Promise.all(
            AUTH_LIST.map((a) => derive(val, a.saltB64, a.iters)),
          );

          const ok = derivedList.some(
            (derived, i) => derived === AUTH_LIST[i].expectedB64,
          );

          if (ok) {
            sessionStorage.setItem(KEY, "1");
            location.replace(nextPath);
          } else {
            fails++;
            err.textContent = "Wrong password.";
            pw.value = "";
            pw.focus();
          }
        }

        go.addEventListener("click", submit);
        pw.addEventListener("keydown", (e) => {
          if (e.key === "Enter") submit();
        });

        pw.focus();
      })();
    </script>
  </body>
</html>
